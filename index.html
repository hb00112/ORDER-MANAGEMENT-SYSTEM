<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HC ORDER MANAGEMENT SYSTEM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HC OMS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://s3.ezgif.com/tmp/ezgif-3-092ebae015.png" type="image/png">
    <meta name="theme-color" content="#4285f4">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        .section {
            display: none;
            margin-top: -20px;
            padding: 20px;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .active {
            display: block;
        }

        .nav-link.active {
            font-weight: bold;
            color: #007bff;
        }

        .nav-link {
            float: left;
            margin-right: -6px;
            margin-bottom: -10px;
        }

        .nav-link:last-child {
            margin-right: 0PX;
        }

        .nav-link:hover {
            color: #0056b3;
        }

        #orderSummary {
            margin-top: 15px;
            border-top: 2px solid #007bff;
            padding-top: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .navbar {
            padding: 10px;
            background-color: #007bff;
            color: rgb(0, 0, 0);
        }

        .navbar-brand {
            font-size: 1.5rem;
            color: rgb(0, 0, 0);
        }

        .nav-link {
            font-size: 1.3rem;
            color: rgb(0, 0, 0);
        }

        .btn {
            font-size: 1rem;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #007bff;
            border: none;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .table {
            font-size: 0.9rem;
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 10px;
            border: 1px solid #dee2e6;
        }

        .table th {
            background-color: #007bff;
            color: white;
        }

        .table tbody tr:hover {
            background-color: #f1f1f1;
        }

        @media (min-width: 768px) {
            body::before {
                content: "This application is designed for mobile devices only. Please access it on a mobile device or use a mobile device emulator.";
                display: block;
                padding: 20px;
                text-align: center;
                font-size: 18px;
                color: #dc3545;
            }

            .container {
                display: none;
            }
        }

        .navbar-brand img {
            border-radius: 50%;
            overflow: hidden;
        }

        .slide-menu {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            background-color: #000;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .slide-menu a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 18px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .slide-menu a:hover {
            color: #f1f1f1;
        }

        .slide-menu .close-btn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        #menuToggle {
            font-size: 24px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            color: #000;
            padding: 0;
            margin-right: 15px;
        }

        .section {
            display: none;
            padding: 20px;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .section.active {
            display: block;
        }

        #partySearch {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #partyList {
            position: absolute;
            width: calc(100% - 30px);
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
            display: none;
        }

        #partyList a {
            padding: 10px;
            text-decoration: none;
            display: block;
            color: #333;
        }

        #partyList a:hover {
            background-color: #f1f1f1;
        }

        .section h4 {
            text-align: center;
            font-weight: 900;
        }

        #homeScreen {
            text-align: center;
            padding:100px 0px;
            width: 100%;
            /* Adjust container width if needed */
            max-width: 800px;
            margin-top: 0px; /*HC TEXT HEIGHT*/
            padding-bottom: 350PX;

            
        
        }

        #homeScreen h3 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: bold;
            /* Make text bold */
            
        }

        .text-effect-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 200px;
        }

        .text-effect-wrapper::before {
            content: "";
            position: absolute;
            top: -100%;
            left: -100%;
            right: -100%;
            bottom: -100%;
            background:
                radial-gradient(circle, white, transparent 25%) 0 0/25% 25%,
                radial-gradient(circle, white, transparent 25%) 50% 50%/12.5% 12.5%;
            mix-blend-mode: color-dodge;
            animation: shimmer 5s infinite linear;
        }

        @keyframes shimmer {
            to {
                transform: translate(50%, 50%);
            }
        }

        .hc-text {
            font-size: 8rem;
            font-weight: bold;
            font-style: italic;
            font-family: 'Dancing Script', cursive;
            background-image: linear-gradient(to right, #8B0000, #0000FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            overflow: hidden;
            /* Added line */
        }

        #master {
            text-align: center;
            /* Center the buttons horizontally */
        }

        #homeScreen h4 {
            font-size: 1.8rem;
            margin-top: 20px;
            font-weight: bold;
        }

        .password-input {
            -webkit-text-security: disc;
            -moz-text-security: disc;
            -text-security: disc;
        }

        #backup-details-table {
            width: 100%;
            border-collapse: collapse;
        }

        #backup-details-table th,
        #backup-details-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        #backup-details-table th {
            background-color: #f2f2f2;
        }

        .category-container {
            margin-bottom: 15px;
            margin-top: 10px;
            font-size: 18px;
            /* Increased font size for category container */
        }

        .category-container label {
            margin-right: 10px;
            font-size: 18px;
            /* Increased font size for labels */
        }

        .size-quantity-grid {
            display: table;
            border-collapse: collapse;
            width: 100%;
            margin-top: 5px;
        }

        .size-quantity-row {
            display: table-row;
        }

        .size-cell,
        .quantity-cell {
            display: table-cell;
            padding: 6px;
            border: 1px solid #000000;
            font-size: 18px;
            /* Increased font size for size and quantity cells */
            vertical-align: middle;
        }

        .size-cell {
            font-weight: bold;
            width: 30px;
        }

        .quantity-cell {
            text-align: left;
        }

        .qty-label {
            display: inline-block;
            margin-right: 8px;
            font-size: 18px;
            /* Increased font size for quantity label */
        }

        .custom-qty {
            width: 35px;
            display: inline-block;
            vertical-align: middle;
            font-size: 18px;
            /* Increased font size for custom quantity input */
        }

        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .approval-content {
            text-align: center;
            color: white;
            font-family: 'Arial', sans-serif;
        }

        .approval-content h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .approval-content p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }

        .loading-animation {
            display: flex;
            justify-content: center;
        }

        .circle {
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            margin: 0 10px;
            animation: bounce 1.5s infinite ease-in-out;
        }

        .circle:nth-child(2) {
            animation-delay: 0.2s;
        }

        .circle:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        #passwordModal2 .modal-content {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
        }

        #passwordModal2 .modal-header {
            border-bottom: none;
            padding: 1.5rem 1.5rem 0.5rem;
        }

        #passwordModal2 .modal-body {
            padding: 1.5rem;
        }

        #passwordModal2 .modal-footer {
            border-top: none;
            padding: 0.5rem 1.5rem 1.5rem;
        }

        #passwordInput2.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        #passwordError2 {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        #orders {
            position: relative;
            padding-bottom: 60px;
            /* Adjust this value based on your footer height */
            margin-top: 10px;
        }

        .order-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #f8f9fa;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .order-footer button {
            width: 48%;
            /* Adjust as needed */
        }
    </style>
</head>

<body>
    <div class="modal fade" id="usernameModal" tabindex="-1" aria-labelledby="usernameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="usernameModalLabel">Welcome!</h5>
                </div>
                <div class="modal-body">
                    <p>Please enter your username:</p>
                    <input type="text" id="usernameInput" class="form-control" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="saveUsername">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="offlineAlert" class="alert alert-warning" style="display: none;" role="alert">
        You are currently offline. Some features may be limited.
    </div>
    <nav class="navbar navbar-expand navbar-light bg-light">
        <div class="container-fluid">
            <button id="menuToggle" class="btn btn-link">â˜°</button>
            <div class="navbar-nav">
                <a class="nav-link active" href="#" data-section="orders">Orders</a>
                <a class="nav-link" href="#" data-section="pendingOrders">Pending</a>
                <a class="nav-link" href="#" data-section="billing">Billing</a>
                <a class="nav-link" href="#" data-section="sentOrders">Sent</a>
            </div>
        </div>
    </nav>
    <div id="homeScreen" class="section active">
        <h3>Hello <span id="userNameDisplay"></span></h3>
        <div class="text-effect-wrapper">
            <h1 class="hc-text">HC</h1>
        </div>
        <h4>Hreenkar Creation</h4>
    </div>
    <div id="slideMenu" class="slide-menu">
        <a href="#" class="close-btn">&times;</a>
        <a href="#" data-section="backupdetails">Backup Details</a>
        <a href="#" data-section="backupRestore">Backup & Restore</a>
        <a href="#" data-section="xlsExport">XLS Export</a>
        <a href="#" data-section="deletedOrders">Deleted Orders</a>
        <a href="#" data-section="activityLogs">Activity Logs</a>
        <a href="#" data-section="master">Master</a>
        <a href="#" data-section="userManagement">User Management</a>
    </div>
    <div id="backupdetails" class="section">
        <h4>Backup Details</h4>
        <table id="backup-details-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Date</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                <!-- Backup details will be inserted here -->
            </tbody>
        </table>
    </div>
    <div id="backupRestore" class="section">
        <h4>Backup & Restore</h4>
        <button id="backupBtn" class="btn btn-primary" data-bs-toggle="modal"
            data-bs-target="#backupModal">Backup</button>
        <button id="restoreBtn" class="btn btn-primary" data-bs-toggle="modal"
            data-bs-target="#restoreModal">Restore</button>

    </div>

    <!-- Backup Modal -->
    <div class="modal fade" id="backupModal" tabindex="-1" aria-labelledby="backupModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="backupModalLabel">BACKUP</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Backup Data</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Party Master Data</td>
                                <td>
                                    <button class="btn btn-sm btn-primary download-btn"
                                        data-type="party_master">Download</button>
                                    <button class="btn btn-sm btn-success send-btn"
                                        data-type="party_master">Send</button>
                                </td>
                            </tr>
                            <tr>
                                <td>Item Master Data</td>
                                <td>
                                    <button class="btn btn-sm btn-primary download-btn"
                                        data-type="item">Download</button>
                                    <button class="btn btn-sm btn-success send-btn" data-type="item">Send</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Restore Modal -->
    <div class="modal fade" id="restoreModal" tabindex="-1" aria-labelledby="restoreModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="restoreModalLabel">Restore Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="restoreFile" class="form-label">Upload JSON File</label>
                        <input class="form-control" type="file" id="restoreFile" accept=".json">
                    </div>
                    <button id="uploadRestoreFile" class="btn btn-primary">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Selection Modal -->
    <div class="modal fade" id="dataSelectionModal" tabindex="-1" aria-labelledby="dataSelectionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dataSelectionModalLabel">Select Data to Restore</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllCheckbox">
                                </th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="dataSelectionBody">
                            <!-- Data entries will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="restoreSelectedData">Restore Selected</button>
                </div>
            </div>
        </div>
    </div>

    <div id="xlsExport" class="section">
        <h4>XLS Export</h4>
        <p>XLS export functionality will be implemented here.</p>
    </div>

    <div id="deletedOrders" class="section">
        <h4>Deleted Orders</h4>
        <p>Deleted orders will be displayed here.</p>
    </div>

    <div id="activityLogs" class="section">
        <h4>Activity Logs</h4>
        <div id="logsList"></div>
    </div>
    <div id="master" class="section">
        <h4>Master</h4>
        <button class="btn btn-primary" id="partyMasterBtn">Party Master</button>
        <button class="btn btn-primary" id="itemMasterBtn">Item Master</button>
    </div>
    <div id="userManagement" class="section">
        <h4>User Management</h4>
        <button class="btn btn-primary" id="usersBtn">Users</button>
        <button class="btn btn-primary" id="approvalRequestsBtn">Approval Requests</button>
    </div>

    <div id="users" class="section">
        <h4>Users</h4>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersBody"></tbody>
        </table>
    </div>

    <div id="approvalRequests" class="section">
        <h4>Approval Requests</h4>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="approvalRequestsBody"></tbody>
        </table>
    </div>

    <div id="partyMaster" class="section">
        <h4>Party Master</h4>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Party Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="partyMasterBody"></tbody>
        </table>
    </div>
    <div id="itemMaster" class="section">
        <h2>Item Master</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Category</th>
                    <th>Sizes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="itemMasterBody"></tbody>
        </table>
    </div>
    <div id="orders" class="section">
        <h4>Orders</h4>
        <form id="orderForm"></form>
            <div class="mb-3">
                <input type="text" class="form-control" id="partySearch" placeholder="Search or add party">
                <div id="partyList" class="list-group mt-2" style="display: none;"></div>
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" id="itemSearch" placeholder="Search or add item">
                <div id="itemList" class="list-group mt-2" style="display: none;"></div>
            </div>
            <!-- The item details and size/quantity grid will be inserted here dynamically -->
        </form>
        <div class="order-footer">
            <button type="button" class="btn btn-primary" id="addToCartBtn">Add to Cart</button>
            <button type="button" class="btn btn-success" id="saveOrderBtn">Save Order</button>
        </div>
        <!-- The cart summary table will be inserted here dynamically -->
    </div>
    <div class="container mt-2">
        
        <!-- Pending Orders Section -->
        <div id="pendingOrders" class="section">
            <h4>Pending Orders</h4>
            <input type="text" class="form-control form-control-sm mb-2" id="pendingOrderSearch"
                placeholder="Search orders...">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>ORD NO.</th>
                        <th>Party</th>
                        <th>Items</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="pendingOrdersBody"></tbody>
            </table>
        </div>

        <!-- Billing Section -->
        <div id="billing" class="section">
            <h4>Billing</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Order Number</th>
                            <th>Party Name</th>
                            <th>Items</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="billingOrdersBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Sent Orders Section -->
        <div id="sentOrders" class="section">
            <h4>Sent Orders</h4>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Party</th>
                        <th>Items</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="sentOrdersBody"></tbody>
            </table>
        </div>
    </div>
    <div id="pendingApprovalScreen" class="fullscreen-overlay" style="display: none;">
        <div class="approval-content">
            <h1>Registration Pending</h1>
            <p>Please wait for your registration to be approved.</p>
            <div class="loading-animation">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
        </div>
    </div>
    <script>
        //home screen
        let username = null;
        let orderCounter = 0;

        //activity log
        function logActivity(action, username) {
            const now = new Date();
            const activityLog = {
                action: action,
                username: username,
                timestamp: now.toISOString(),
                date: now.toLocaleDateString(),
                time: now.toLocaleTimeString()
            };
            firebase.database().ref('activityLogs').push(activityLog);
        }

        //order
        let items = [
            { name: "o.e 2pccs", category: ["mix", "1pcs", "2pcs"], sizes: ["s", "m", "l", "xl", "2xl"] },
            { name: "reply", sizes: ["s", "m", "l", "xl", "2xl"] },
            { name: "clasz", sizes: ["45", "50", "55", "60", "65", "70", "75"] },
            { name: "salsa", sizes: ["45", "50", "55", "60", "65", "70", "75"] }
        ];

        function addNewItem(itemName) {
            if (!items.some(item => item && item.name === itemName)) {
                // Create a modal dynamically
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'newItemModal';
                modal.setAttribute('tabindex', '-1');
                modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Item: ${itemName}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="itemCategory" class="form-label">Category (optional, separate multiple with space)</label>
                            <input type="text" class="form-control" id="itemCategory">
                        </div>
                        <div class="mb-3">
                            <label for="itemSizes" class="form-label">Sizes (mandatory, separate with space)</label>
                            <input type="text" class="form-control" id="itemSizes" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveNewItem">Save Item</button>
                    </div>
                </div>
            </div>
        `;
                document.body.appendChild(modal);

                const newItemModal = new bootstrap.Modal(document.getElementById('newItemModal'));
                newItemModal.show();

                document.getElementById('saveNewItem').addEventListener('click', function () {
                    const category = document.getElementById('itemCategory').value.split(' ').filter(Boolean);
                    const sizes = document.getElementById('itemSizes').value.split(' ').filter(Boolean);

                    if (sizes.length === 0) {
                        alert('Please enter at least one size.');
                        return;
                    }

                    const newItem = { name: itemName, category: category, sizes: sizes };
                    items.push(newItem);
                    items.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));

                    // Save to Firebase
                    firebase.database().ref('items').set(items).then(() => {
                        console.log(`Added new item: ${itemName}`);
                        logActivity(`created new item "${itemName}"`, username);
                        alert(`New item "${itemName}" has been added successfully.`);
                        newItemModal.hide();
                        document.body.removeChild(modal);
                    }).catch(error => {
                        console.error("Error adding new item:", error);
                        alert("An error occurred while adding the new item. Please try again.");
                    });

                    document.getElementById('itemSearch').value = itemName;
                    document.getElementById('itemList').style.display = 'none';
                    showItemDetails(newItem);
                });
            } else {
                console.log(`Item "${itemName}" already exists.`);
                alert(`Item "${itemName}" already exists in the list.`);
            }
        }



      

        //loading
        function loadItemsFromFirebase() {
            firebase.database().ref('items').once('value', (snapshot) => {
                const firebaseItems = snapshot.val();
                if (firebaseItems) {
                    // Merge Firebase items with the initial items
                    items = [...items, ...Object.values(firebaseItems)];
                    // Remove duplicates and undefined items
                    items = Array.from(new Set(items.filter(item => item && item.name).map(item => JSON.stringify(item))))
                        .map(item => JSON.parse(item));
                    // Sort items by name, handling potential undefined names
                    items.sort((a, b) => {
                        if (!a.name) return 1;
                        if (!b.name) return -1;
                        return a.name.localeCompare(b.name, undefined, { sensitivity: 'base' });
                    });
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            //backend
            const firebaseConfig = {
                apiKey: "AIzaSyBRV-i_70Xdk86bNuQQ43jiYkRNCXGvvyo",
                authDomain: "hcoms-221aa.firebaseapp.com",
                databaseURL: "https://hcoms-221aa-default-rtdb.firebaseio.com",
                projectId: "hcoms-221aa",
                storageBucket: "hcoms-221aa.appspot.com",
                messagingSenderId: "817694176734",
                appId: "1:817694176734:web:176bf69333bd7119d3194f",
                measurementId: "G-JB143EY71N"
            };
            firebase.initializeApp(firebaseConfig);
            function showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');

                // Hide home screen when other sections are clicked
                if (sectionId !== 'homeScreen') {
                    document.getElementById('homeScreen').classList.remove('active');
                }
            }

            // Show home screen by default and display username
            showSection('homeScreen');
            const userNameDisplay = document.getElementById('userNameDisplay');
            userNameDisplay.textContent = username || 'User';

            function checkUserStatus() {
                return new Promise((resolve, reject) => {
                    const storedUsername = localStorage.getItem('hcUsername');
                    if (storedUsername) {
                        firebase.database().ref('users').once('value', (snapshot) => {
                            const users = snapshot.val();
                            if (users && Object.values(users).includes(storedUsername)) {
                                username = storedUsername;
                                document.getElementById('userNameDisplay').textContent = username;
                                console.log('Welcome back, ' + username);
                                resolve('active');
                            } else {
                                firebase.database().ref('approvalRequests').once('value', (snapshot) => {
                                    const requests = snapshot.val();
                                    if (requests && Object.values(requests).includes(storedUsername)) {
                                        resolve('pending');
                                    } else {
                                        localStorage.removeItem('hcUsername');
                                        resolve('new');
                                    }
                                });
                            }
                        });
                    } else {
                        resolve('new');
                    }
                });
            }

            function registerUser() {
                let usernameModal = new bootstrap.Modal(document.getElementById('usernameModal'), {
                    backdrop: 'static',
                    keyboard: false
                });
                usernameModal.show();

                document.getElementById('saveUsername').addEventListener('click', function () {
                    let inputUsername = document.getElementById('usernameInput').value.trim();
                    if (inputUsername) {
                        // Show loading animation
                        usernameModal.hide();
                        document.body.innerHTML += '<div class="fullscreen-overlay" id="loadingOverlay"><div class="approval-content"><h1>Submitting Request</h1><div class="loading-animation"><div class="circle"></div><div class="circle"></div><div class="circle"></div></div></div></div>';

                        firebase.database().ref('approvalRequests').push(inputUsername).then(() => {
                            localStorage.setItem('hcUsername', inputUsername);
                            logActivity('New user registration request', inputUsername);

                            // Remove loading overlay and show pending approval screen
                            document.getElementById('loadingOverlay').remove();
                            document.getElementById('pendingApprovalScreen').style.display = 'flex';
                        });
                    } else {
                        alert('Please enter a valid username.');
                    }
                });
            }

            checkUserStatus().then((status) => {
                switch (status) {
                    case 'active':
                        // User is active, allow access to the application
                        break;
                    case 'pending':
                        document.getElementById('pendingApprovalScreen').style.display = 'flex';
                        break;
                    case 'new':
                        registerUser();
                        break;
                }
            });

            document.querySelectorAll('.nav-link, #slideMenu a[data-section]').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);

                    // Update active state for nav links
                    document.querySelectorAll('.nav-link').forEach(navLink => navLink.classList.remove('active'));
                    if (this.classList.contains('nav-link')) {
                        this.classList.add('active');
                    }

                    // Close slide menu if it's open
                    slideMenu.style.width = '0';
                });
            });

            firebase.database().ref('parties').once('value', (snapshot) => {
                const firebaseParties = snapshot.val();
                if (firebaseParties) {
                    parties = parties.concat(Object.values(firebaseParties));
                    parties = [...new Set(parties)]; // Remove duplicates
                    sortParties(); // Sort the combined list
                }
            });
            loadPendingOrders();
            loadBillingOrders();
            loadSentOrders();
            const sendTime = '09:19'; // 1:34 PM

            async function sendPartyNamesToTelegram() {
                // Retrieve the parties from Firebase
                const partiesRef = firebase.database().ref('parties');
                const partiesSnapshot = await partiesRef.once('value');
                const parties = partiesSnapshot.val();

                // Create a simple array of party names
                const partyNames = parties || [];

                // Create a JSON string from the party names array
                const jsonData = JSON.stringify(partyNames);

                // Create a blob from the JSON data
                const blob = new Blob([jsonData], { type: 'application/json' });

                // Get the current date and time
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hour = String(date.getHours()).padStart(2, '0');
                const minute = String(date.getMinutes()).padStart(2, '0');
                const second = String(date.getSeconds()).padStart(2, '0');

                // Create a file name
                const fileName = `partydata_${year}${month}${day}.json`;

                // Create a file from the blob
                const file = new File([blob], fileName, { type: 'application/json' });

                // Create a form data object
                const formData = new FormData();
                formData.append('document', file);

                // Send the file to Telegram
                const url = `https://api.telegram.org/bot7401966895:AAFu7gNrOPhMXJQNJTRk4CkK4TjRr09pxUs/sendDocument?chat_id=-4527298165`;
                fetch(url, {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Telegram message sent:', data);

                        // Create a backup details object
                        const backupDetails = {
                            type: 'Party Data',
                            date: `${year}-${month}-${day}`,
                            time: `${hour}:${minute}:${second}`,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        };

                        // Add the backup details to Firebase
                        firebase.database().ref('backupDetails').push(backupDetails);

                        // Update the last backup date in Firebase
                        firebase.database().ref('lastBackup').set({
                            date: date.toDateString(),
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });

                        // Refresh the backup details table
                        loadBackupDetails();
                    })
                    .catch(error => console.error('Error sending Telegram message:', error));
            }

            // Function to load and display backup details
            function loadBackupDetails() {
                const backupDetailsTable = document.getElementById('backup-details-table');
                const tableBody = backupDetailsTable.getElementsByTagName('tbody')[0];
                tableBody.innerHTML = ''; // Clear existing rows

                firebase.database().ref('backupDetails').orderByChild('timestamp').limitToLast(10).once('value', (snapshot) => {
                    const backups = [];
                    snapshot.forEach((childSnapshot) => {
                        backups.push(childSnapshot.val());
                    });

                    backups.reverse().forEach((backup) => {
                        const newRow = tableBody.insertRow();
                        const typeCell = newRow.insertCell();
                        const dateCell = newRow.insertCell();
                        const timeCell = newRow.insertCell();
                        typeCell.textContent = backup.type;
                        dateCell.textContent = backup.date;
                        timeCell.textContent = backup.time;
                    });
                });
            }

            // Function to check if it's time to send the data
            function checkSendTime() {
                const currentTime = new Date();
                const currentTimeString = `${currentTime.getHours()}:${currentTime.getMinutes()}`;

                // Check if it's past the specified time and if the backup hasn't been sent today
                if (currentTimeString >= sendTime || currentTime.getHours() >= parseInt(sendTime.split(':')[0])) {
                    checkAndSendBackup();
                }
            }

            // Function to check if backup should be sent
            function checkAndSendBackup() {
                firebase.database().ref('lastBackup').once('value', (snapshot) => {
                    const lastBackup = snapshot.val();
                    const today = new Date().toDateString();

                    if (!lastBackup || lastBackup.date !== today) {
                        sendPartyNamesToTelegram();
                    }
                });
            }

            checkAndSendBackup();
            loadBackupDetails();

            // Set an interval to check the time every minute
            setInterval(checkSendTime, 60000); // 60000 milliseconds = 1 minute

            // Reset the backup flag at midnight
            function resetDailyBackupFlag() {
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 0) {
                    firebase.database().ref('lastBackup').remove();
                }
            }

            // Check to reset the flag every hour
            setInterval(resetDailyBackupFlag, 3600000); // 3600000 milliseconds = 1 hour

            document.addEventListener('DOMContentLoaded', checkAndSendBackup);

            // Reset the backup flag at midnight
            function resetDailyBackupFlag() {
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 0) {
                    firebase.database().ref('lastBackup').remove();
                }
            }

            // Check to reset the flag every hour
            setInterval(resetDailyBackupFlag, 3600000); // 3600000 milliseconds = 1 hour


            //order
            let parties = ["PARTY A - AREA1", "PARTY B - AREA2", "PARTY C - AREA3", "XYLO - AREA4"];
            const partySearch = document.getElementById('partySearch');
            const partyList = document.getElementById('partyList');

            partySearch.addEventListener('focus', () => showParties());
            partySearch.addEventListener('input', () => showParties(partySearch.value));

            document.addEventListener('click', function (e) {
                if (e.target !== partySearch && !partyList.contains(e.target)) {
                    partyList.style.display = 'none';
                }
            });
            function sortParties() {
                parties.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
            }

            function showParties(filter = '') {
                partyList.innerHTML = '';
                const filteredParties = parties.filter(party =>
                    party.toLowerCase().includes(filter.toLowerCase())
                );

                filteredParties.forEach(party => {
                    const item = document.createElement('a');
                    item.classList.add('list-group-item', 'list-group-item-action');
                    item.textContent = party;
                    item.href = '#';
                    item.addEventListener('click', function (e) {
                        e.preventDefault();
                        partySearch.value = party;
                        partyList.style.display = 'none';
                    });
                    partyList.appendChild(item);
                });

                if (filteredParties.length === 0 && filter !== '') {
                    const addNewItem = document.createElement('a');
                    addNewItem.classList.add('list-group-item', 'list-group-item-action');
                    addNewItem.textContent = `Add "${filter}" as a new party`;
                    addNewItem.href = '#';
                    addNewItem.addEventListener('click', function (e) {
                        e.preventDefault();
                        addNewParty(filter); // Change this line from addNewItem to addNewParty
                    });
                    partyList.appendChild(addNewItem);
                }

                partyList.style.display = 'block';
            }
            function addNewParty(partyInput) {
    const [partyName, area] = partyInput.split(' - ').map(s => s.trim());
    if (!partyName || !area) {
        alert('Please enter the party name and area in the format "PARTYNAME - AREA"');
        return;
    }

    const fullPartyName = `${partyName} - ${area}`;
    if (!parties.includes(fullPartyName)) {
        parties.push(fullPartyName);
        sortParties();
        // Save to Firebase
        firebase.database().ref('parties').set(parties);
        console.log(`Added new party: ${fullPartyName}`);

        // Log the activity
        const now = new Date();
        const activityLog = {
            action: 'Created new party',
            partyName: fullPartyName,
            timestamp: now.toISOString(),
            date: now.toLocaleDateString(),
            time: now.toLocaleTimeString(),
            username: username
        };
        firebase.database().ref('activityLogs').push(activityLog);

        // Send Telegram message
        const chatId = '-4527298165';
        const botToken = '7401966895:AAFu7gNrOPhMXJQNJTRk4CkK4TjRr09pxUs';
        const message = `${username}: created new party ${fullPartyName}`;
        const url = `https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(message)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => console.log('Telegram message sent:', data))
            .catch(error => console.error('Error sending Telegram message:', error));
    }
    partySearch.value = fullPartyName;
    partyList.style.display = 'none';
}
           // Existing code
function createCategoryRadios(categories) {
    return `
        <div class="category-container">
            ${categories.map((cat, index) => `
                <label>
                    <input type="radio" name="category" value="${cat}" ${index === 0 ? 'checked' : ''}>
                    ${cat}
                </label>
            `).join('')}
        </div>
    `;
}

function showParties(filter = '') {
    partyList.innerHTML = '';
    const filteredParties = parties.filter(party =>
        party.toLowerCase().includes(filter.toLowerCase())
    );

    filteredParties.forEach(party => {
        const item = document.createElement('a');
        item.classList.add('list-group-item', 'list-group-item-action');
        item.textContent = party;
        item.href = '#';
        item.addEventListener('click', function (e) {
            e.preventDefault();
            partySearch.value = party;
            partyList.style.display = 'none';
        });
        partyList.appendChild(item);
    });

    if (filteredParties.length === 0 && filter !== '') {
        const addNewItem = document.createElement('a');
        addNewItem.classList.add('list-group-item', 'list-group-item-action');
        addNewItem.textContent = `Add "${filter}" as a new party`;
        addNewItem.href = '#';
        addNewItem.addEventListener('click', function (e) {
            e.preventDefault();
            addNewParty(filter);
        });
        partyList.appendChild(addNewItem);
    }

    partyList.style.display = 'block';
}
function showItemDetails(item) {
    const existingDetailsContainer = document.getElementById('itemDetailsContainer');
    if (existingDetailsContainer) {
        existingDetailsContainer.remove();
    }

    const detailsContainer = document.createElement('div');
    detailsContainer.id = 'itemDetailsContainer';
    detailsContainer.innerHTML = `
        ${item.category ? createCategoryRadios(item.category) : ''}
        ${createSizeQuantityGrid(item.sizes)}
    `;

    const itemList = document.getElementById('itemList');
    itemList.insertAdjacentElement('afterend', detailsContainer);
}


function createSizeQuantityGrid(sizes) {
    const quantities = ['1', '2', '3', '4', '5', '_'];
    return `
        <div class="size-quantity-grid">
            ${sizes.map(size => `
                <div class="size-quantity-row">
                    <div class="size-cell">${size}</div>
                    <div class="quantity-cell">
                        ${quantities.map(qty => `
                            <label class="qty-label">
                                <input type="radio" name="qty_${size}" value="${qty}">
                                ${qty === '_' ? `<input type="number" class="custom-qty" min="1" style="width: 40px;" inputmode="numeric" oninput="this.previousElementSibling.checked = true;">` : qty}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// New code for cart functionality
let cart = [];

function addToCart() {
    const itemName = document.getElementById('itemSearch').value;
    const item = items.find(i => i.name === itemName);
    
    if (!item) {
        alert('Please select a valid item.');
        return;
    }

    const selectedCategory = document.querySelector('input[name="category"]:checked');
    const category = selectedCategory ? selectedCategory.value : '';

    const selectedQuantities = {};
    item.sizes.forEach(size => {
        const selectedQty = document.querySelector(`input[name="qty_${size}"]:checked`);
        if (selectedQty) {
            const qty = selectedQty.value === '_' ? 
                selectedQty.nextElementSibling.value : 
                selectedQty.value;
            if (qty && parseInt(qty) > 0) {
                selectedQuantities[size] = parseInt(qty);
            }
        }
    });

    if (Object.keys(selectedQuantities).length === 0) {
        alert('Please select at least one size and quantity.');
        return;
    }

    const existingItemIndex = cart.findIndex(cartItem => cartItem.name === itemName);

    if (existingItemIndex !== -1) {
        // Merge quantities for existing item
        Object.entries(selectedQuantities).forEach(([size, qty]) => {
            if (cart[existingItemIndex].quantities[size]) {
                cart[existingItemIndex].quantities[size] += qty;
            } else {
                cart[existingItemIndex].quantities[size] = qty;
            }
        });
        cart[existingItemIndex].total = Object.values(cart[existingItemIndex].quantities).reduce((sum, qty) => sum + qty, 0);
    } else {
        // Add new item to cart
        const cartItem = {
            name: itemName,
            category: category,
            quantities: selectedQuantities,
            total: Object.values(selectedQuantities).reduce((sum, qty) => sum + qty, 0)
        };
        cart.push(cartItem);
    }

    updateCartSummary();
    resetItemSelection();
}
// Update the updateCartSummary function
function updateCartSummary() {
    const cartSummary = document.getElementById('cartSummary') || createCartSummaryTable();
    const tbody = cartSummary.querySelector('tbody');
    tbody.innerHTML = '';

    let totalQuantity = 0;

    cart.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.name} ${item.category ? `(${item.category})` : ''}</td>
            <td>${Object.entries(item.quantities)
                .map(([size, qty]) => `${size}/${qty}`)
                .join(', ')}</td>
            <td>${item.total}</td>
        `;
        row.addEventListener('click', () => showEditItemModal(index, false));
        tbody.appendChild(row);
        totalQuantity += item.total;
    });

    // Update total quantity in the cart button
    const cartButton = document.getElementById('saveOrderBtn');
    cartButton.textContent = `Cart (${totalQuantity})`;
}

// Function to show edit item modal
function showEditItemModal(itemIndex, isOrderSummaryModal = false) {
    const item = cart[itemIndex];
    const allSizes = items.find(i => i.name === item.name).sizes;
    
    // Remove any existing edit modal
    const existingModal = document.getElementById('editItemModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'editItemModal';
    modal.setAttribute('tabindex', '-1');
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Item: ${item.name}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ${allSizes.map(size => `
                        <div class="mb-3 d-flex align-items-center">
                            <label class="form-label me-2 mb-0" style="width: 50px;">${size}</label>
                            <div class="input-group" style="width: 150px;">
                                <button class="btn btn-outline-secondary minus-btn" type="button" data-size="${size}">-</button>
                                <input type="number" class="form-control text-center" id="qty_${size}" value="${item.quantities[size] || 0}" min="0" readonly>
                                <button class="btn btn-outline-secondary plus-btn" type="button" data-size="${size}">+</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteItemBtn">Delete Item</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveItemBtn">Save Item</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    const editModalInstance = new bootstrap.Modal(document.getElementById('editItemModal'));

    // Add event listeners for plus and minus buttons
    modal.querySelectorAll('.minus-btn').forEach(btn => {
        btn.addEventListener('click', () => updateQuantity(btn.dataset.size, -1));
    });
    modal.querySelectorAll('.plus-btn').forEach(btn => {
        btn.addEventListener('click', () => updateQuantity(btn.dataset.size, 1));
    });

    document.getElementById('saveItemBtn').addEventListener('click', () => {
        editCartSummaryItem(itemIndex, isOrderSummaryModal);
        editModalInstance.hide();
    });

    document.getElementById('deleteItemBtn').addEventListener('click', () => {
        deleteCartItem(itemIndex, isOrderSummaryModal);
        editModalInstance.hide();
    });

    editModalInstance.show();
}
// Function to update quantity
function updateQuantity(size, change) {
    const input = document.getElementById(`qty_${size}`);
    let newValue = parseInt(input.value) + change;
    newValue = Math.max(0, newValue); // Ensure non-negative value
    input.value = newValue;
}

// Function to edit cart summary item
function editCartSummaryItem(itemIndex, isOrderSummaryModal = false) {
    const item = cart[itemIndex];
    const allSizes = items.find(i => i.name === item.name).sizes;
    let newTotal = 0;

    allSizes.forEach(size => {
        const newQty = parseInt(document.getElementById(`qty_${size}`).value);
        if (newQty > 0) {
            item.quantities[size] = newQty;
            newTotal += newQty;
        } else {
            delete item.quantities[size];
        }
    });

    item.total = newTotal;

    if (newTotal === 0) {
        deleteCartItem(itemIndex, isOrderSummaryModal);
    } else {
        updateCartSummary();
        if (isOrderSummaryModal) {
            updateModalCartSummary();
        }
    }
}
// Function to delete cart item
function deleteCartItem(itemIndex, isOrderSummaryModal = false) {
    cart.splice(itemIndex, 1);
    updateCartSummary();
    if (isOrderSummaryModal) {
        updateModalCartSummary();
    }
}
function createCartSummaryTable() {
    const table = document.createElement('table');
    table.id = 'cartSummary';
    table.className = 'table table-bordered mt-4';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Item Name</th>
                <th>Sizes and Qty</th>
                <th>Item Total</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    document.getElementById('orders').appendChild(table);
    return table;
}

function resetItemSelection() {
    document.getElementById('itemSearch').value = '';
    const itemDetailsContainer = document.getElementById('itemDetailsContainer');
    if (itemDetailsContainer) {
        itemDetailsContainer.remove();
    }
}
// Event listeners
document.getElementById('addToCartBtn').addEventListener('click', addToCart);
// Initialize the cart summary table
createCartSummaryTable();
// Function to show the order summary modal
function showOrderSummaryModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'modal3';
    modal.setAttribute('tabindex', '-1');
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Party Name:</strong> <span id="modalPartyName"></span></p>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Sizes and Qty</th>
                                <th>Item Total</th>
                            </tr>
                        </thead>
                        <tbody id="modalCartSummary"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2"><strong>Total Quantity</strong></td>
                                <td id="modalTotalQuantity"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="placeOrderBtn">Place Order</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    const modalInstance = new bootstrap.Modal(document.getElementById('modal3'));
    
    // Populate modal with data
    document.getElementById('modalPartyName').textContent = document.getElementById('partySearch').value;
    updateModalCartSummary();

    // Add event listener to Place Order button
    document.getElementById('placeOrderBtn').addEventListener('click', showOrderConfirmationModal);

    modalInstance.show();
}
function saveOrderToFirebase(order) {
    return firebase.database().ref('orders').push(order);
}
// Function to show the order confirmation modal
function showOrderConfirmationModal() {
    bootstrap.Modal.getInstance(document.getElementById('modal3')).hide();

    const partyName = document.getElementById('partySearch').value;
    const dateTime = new Date().toISOString();

    // Create and append modal immediately
    const modal = createModal(partyName, dateTime);
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(document.getElementById('modal4'));

    // Show modal immediately
    modalInstance.show();

    // Play sound effect
    playConfirmationSound();

    getNextOrderNumber().then(orderNumber => {
        const order = {
            orderNumber: orderNumber,
            partyName: partyName,
            dateTime: dateTime,
            items: cart,
            status: 'Pending'
        };

        saveOrderToFirebase(order)
            .then(() => {
                // Update modal content with order number
                updateModalContent(orderNumber);

                // Send notification to Telegram
                sendTelegramNotification(partyName, getTotalQuantity(cart), orderNumber);
                loadPendingOrders();
            })
            .catch(error => {
                console.error("Error saving order: ", error);
                alert("An error occurred while saving the order. Please try again.");
            });
    }).catch(error => {
        console.error("Error getting next order number: ", error);
        alert("An error occurred while generating the order number. Please try again.");
    });
}

function createModal(partyName, dateTime) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'modal4';
    modal.setAttribute('tabindex', '-1');
    modal.innerHTML = `
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @keyframes drawCheck {
                0% { stroke-dashoffset: 100; }
                100% { stroke-dashoffset: 0; }
            }
            .modal-content {
                background-color: #ffffff;
                border: none;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                animation: fadeIn 0.6s ease-out;
            }
            .modal-header {
                border-bottom: 1px solid #f0f0f0;
                padding: 1.5rem 2rem;
            }
            .modal-title {
                font-family: 'Arial', sans-serif;
                font-weight: 600;
                color: #333333;
                font-size: 1.5rem;
            }
            .modal-body {
                padding: 2rem;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .confirmation-icon {
    width: 80px;
    height: 80px;
    margin-bottom: 1.5rem;
    animation: fadeIn 0.6s ease-out 0.3s both;
}
.confirmation-icon circle {
    fill: #e6f4ea;  /* Light green background */
    stroke: #34a853;  /* Green stroke for circle */
    stroke-width: 2;
}
.confirmation-icon path {
    fill: none;
    stroke: #34a853;  /* Green checkmark */
    stroke-width: 4;
    stroke-linecap: round;
    stroke-linejoin: round;
    stroke-dasharray: 100;
    stroke-dashoffset: 100;
    animation: drawCheck 0.6s ease-out 0.9s forwards;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes drawCheck {
    to { stroke-dashoffset: 0; }
}
            .order-info {
                text-align: center;
                font-family: 'Arial', sans-serif;
                color: #555555;
                width: 100%;
            }
            .order-info p {
                margin: 0.75rem 0;
                animation: slideUp 0.6s ease-out forwards;
                opacity: 0;
            }
            .order-info p:nth-child(1) { animation-delay: 0.6s; }
            .order-info p:nth-child(2) { animation-delay: 0.75s; }
            .order-info p:nth-child(3) { animation-delay: 0.9s; }
            .order-key {
                font-weight: 600;
                color: #333333;
                margin-right: 0.5rem;
            }
            .btn-primary {
                background-color: #4a90e2;
                border: none;
                padding: 0.75rem 2rem;
                font-weight: 600;
                transition: background-color 0.3s ease;
                font-size: 1rem;
            }
            .btn-primary:hover {
                background-color: #3a7bc8;
            }
            .modal-footer {
                border-top: none;
                padding: 1rem 2rem 2rem;
            }
        </style>
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Confirmation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <svg class="confirmation-icon" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="48"/>
                        <path d="M30 50 L45 65 L70 35"/>
                    </svg>
                    <div class="order-info">
                        <p><span class="order-key">Party Name:</span>${partyName}</p>
                        <p><span class="order-key">Date and Time:</span>${new Date(dateTime).toLocaleString()}</p>
                        <p><span class="order-key">Order Number:</span><span id="orderNumberSpan">Generating...</span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;

    modal.querySelector('.btn-close').addEventListener('click', returnToHomepage);
    modal.querySelector('.btn-primary').addEventListener('click', returnToHomepage);

    return modal;
}

function updateModalContent(orderNumber) {
    const orderNumberSpan = document.getElementById('orderNumberSpan');
    if (orderNumberSpan) {
        orderNumberSpan.textContent = orderNumber;
    }
}

function playConfirmationSound() {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(587.33, audioContext.currentTime); // D5
    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
    gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);
    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);

    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
}

function sendTelegramNotification(partyName, totalQuantity, orderNumber) {
    const token = '6489265710:AAFx6-OaL09SpByMPyfiQBmgetvbtx0InyI';
    const chatId = '-1002170737027';
    const message = `New order received:\nParty Name: ${partyName}\nTotal Quantity: ${totalQuantity}\nOrder Number: ${orderNumber}`;

    fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            chat_id: chatId,
            text: message,
        }),
    })
    .then(response => response.json())
    .then(data => console.log('Telegram notification sent:', data))
    .catch(error => console.error('Error sending Telegram notification:', error));
}

function getTotalQuantity(cartItems) {
    return cartItems.reduce((total, item) => total + item.total, 0);
}
function updateModalCartSummary() {
    const modalCartSummary = document.getElementById('modalCartSummary');
    modalCartSummary.innerHTML = '';
    let totalQuantity = 0;

    cart.forEach((item, index) => {
        const row = document.createElement('tr');
        row.className = 'clickable-row';
        row.dataset.index = index;
        row.innerHTML = `
            <td>${item.name} ${item.category ? `(${item.category})` : ''}</td>
            <td>${Object.entries(item.quantities)
                .map(([size, qty]) => `${size}/${qty}`)
                .join(', ')}</td>
            <td>${item.total}</td>
        `;
        modalCartSummary.appendChild(row);
        totalQuantity += item.total;
    });

    document.getElementById('modalTotalQuantity').textContent = totalQuantity;

    // Add click event listener to rows
    modalCartSummary.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', function() {
            const itemIndex = parseInt(this.dataset.index);
            showEditItemModal(itemIndex, true);
        });
    });
}
// Function to return to homepage
function returnToHomepage() {
    document.getElementById('partySearch').value = '';
    document.getElementById('itemSearch').value = '';
    cart = [];
    updateCartSummary();

    const itemDetailsContainer = document.getElementById('itemDetailsContainer');
    if (itemDetailsContainer) {
        itemDetailsContainer.remove();
    }

    loadPendingOrders(); // Refresh the pending orders list
    console.log('Returned to homepage');
}

// Event listener for Save Order button
document.getElementById('saveOrderBtn').addEventListener('click', showOrderSummaryModal);
document.addEventListener('DOMContentLoaded', () => {
    createCartSummaryTable();
    updateCartSummary();
});

function getNextOrderNumber() {
    return firebase.database().ref('orderCounter').transaction((current) => {
        return (current || 0) + 1;
    }).then((result) => {
        if (result.committed) {
            return `H${result.snapshot.val()}`;
        } else {
            throw new Error("Failed to get next order number");
        }
    });
}






//PENDING ORDER
// Function to load and display pending orders
function loadPendingOrders() {
    const pendingOrdersBody = document.getElementById('pendingOrdersBody');
    pendingOrdersBody.innerHTML = '';

    firebase.database().ref('orders').orderByChild('status').equalTo('Pending').once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const order = childSnapshot.val();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.orderNumber || 'N/A'}</td>
                        <td>${order.partyName || 'N/A'}</td>
                        <td>${order.items && Array.isArray(order.items) ? order.items.map(item => 
                            `${item.name} (${Object.entries(item.quantities || {}).map(([size, qty]) => `${size}/${qty}`).join(', ')})`
                        ).join('; ') : 'No items'}</td>
                        <td>${order.status || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-order" data-order-id="${childSnapshot.key}">View</button>
                            <button class="btn btn-sm btn-success complete-order" data-order-id="${childSnapshot.key}">Mark for Billing</button>
                        </td>
                    `;
                    pendingOrdersBody.appendChild(row);
                });
            } else {
                pendingOrdersBody.innerHTML = '<tr><td colspan="5">No pending orders found</td></tr>';
            }
        })
        .catch(error => {
            console.error("Error loading orders: ", error);
            pendingOrdersBody.innerHTML = '<tr><td colspan="5">Error loading orders</td></tr>';
        });
}

// Function to handle order completion
function markForBilling(orderId) {
    firebase.database().ref('orders').child(orderId).update({ status: 'Waiting for Billing' })
        .then(() => {
            console.log("Order marked for billing successfully");
            loadPendingOrders(); // Reload the pending orders
            loadBillingOrders(); // Load the billing orders (new function to be created)
        })
        .catch(error => {
            console.error("Error marking order for billing: ", error);
        });
}

// Function to view order details
function viewOrderDetails(orderId) {
    firebase.database().ref('orders').child(orderId).once('value')
        .then(snapshot => {
            const order = snapshot.val();
            // Create and show a modal with order details
            // This is left as an exercise, you can create a similar modal to the confirmation modal
        })
        .catch(error => {
            console.error("Error fetching order details: ", error);
        });
}

// Event listeners for pending orders actions
document.getElementById('pendingOrdersBody').addEventListener('click', function(e) {
    if (e.target.classList.contains('complete-order')) {
        markForBilling(e.target.getAttribute('data-order-id'));
    } else if (e.target.classList.contains('view-order')) {
        viewOrderDetails(e.target.getAttribute('data-order-id'));
    }
});

// Search functionality for pending orders
document.getElementById('pendingOrderSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.getElementById('pendingOrdersBody').getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    }
});

// Call this function when the page loads
document.addEventListener('DOMContentLoaded', loadPendingOrders);



//billing section
function loadBillingOrders() {
    const billingOrdersBody = document.getElementById('billingOrdersBody');
    billingOrdersBody.innerHTML = '';

    firebase.database().ref('orders').orderByChild('status').equalTo('Waiting for Billing').once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const order = childSnapshot.val();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.orderNumber || 'N/A'}</td>
                        <td>${order.partyName || 'N/A'}</td>
                        <td>${order.items && Array.isArray(order.items) ? order.items.map(item => 
                            `${item.name} (${Object.entries(item.quantities || {}).map(([size, qty]) => `${size}/${qty}`).join(', ')})`
                        ).join('; ') : 'No items'}</td>
                        <td>${order.status || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-order" data-order-id="${childSnapshot.key}">View</button>
                            <button class="btn btn-sm btn-success bill-order" data-order-id="${childSnapshot.key}">Bill</button>
                        </td>
                    `;
                    billingOrdersBody.appendChild(row);
                });
            } else {
                billingOrdersBody.innerHTML = '<tr><td colspan="5">No orders waiting for billing</td></tr>';
            }
        })
        .catch(error => {
            console.error("Error loading billing orders: ", error);
            billingOrdersBody.innerHTML = '<tr><td colspan="5">Error loading billing orders</td></tr>';
        });
}

document.getElementById('billingOrdersBody').addEventListener('click', function(e) {
    if (e.target.classList.contains('bill-order')) {
        billOrder(e.target.getAttribute('data-order-id'));
    } else if (e.target.classList.contains('view-order')) {
        viewOrderDetails(e.target.getAttribute('data-order-id'));
    }
});

function billOrder(orderId) {
    firebase.database().ref('orders').child(orderId).update({ status: 'Sent' })
        .then(() => {
            console.log("Order billed and moved to Sent successfully");
            loadBillingOrders(); // Reload the billing orders
            loadSentOrders(); // Load the sent orders (new function to be created)
        })
        .catch(error => {
            console.error("Error billing order: ", error);
        });
}




//sent order section
function loadSentOrders() {
    const sentOrdersBody = document.getElementById('sentOrdersBody');
    sentOrdersBody.innerHTML = '';

    firebase.database().ref('orders').orderByChild('status').equalTo('Sent').once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const order = childSnapshot.val();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${order.orderNumber || 'N/A'}</td>
                        <td>${order.partyName || 'N/A'}</td>
                        <td>${order.items && Array.isArray(order.items) ? order.items.map(item => 
                            `${item.name} (${Object.entries(item.quantities || {}).map(([size, qty]) => `${size}/${qty}`).join(', ')})`
                        ).join('; ') : 'No items'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-order" data-order-id="${childSnapshot.key}">View</button>
                        </td>
                    `;
                    sentOrdersBody.appendChild(row);
                });
            } else {
                sentOrdersBody.innerHTML = '<tr><td colspan="4">No sent orders found</td></tr>';
            }
        })
        .catch(error => {
            console.error("Error loading sent orders: ", error);
            sentOrdersBody.innerHTML = '<tr><td colspan="4">Error loading sent orders</td></tr>';
        });
}

document.getElementById('sentOrdersBody').addEventListener('click', function(e) {
    if (e.target.classList.contains('view-order')) {
        viewOrderDetails(e.target.getAttribute('data-order-id'));
    }
});



// Create audio context
let audioContext;

// Debounce flag
let isDebouncing = false;

// Volume control (0.0 to 1.0)
let hapticVolume = 0.2; // Increased from 0.1 to 0.3

// Function to initialize audio context
function initAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
}

// Function to create soft sound
function createSoftSound() {
    initAudioContext();

    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 note

    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
    gainNode.gain.linearRampToValueAtTime(hapticVolume, audioContext.currentTime + 0.01);
    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.05);

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.05);
}

// Function to set haptic feedback volume
function setHapticVolume(volume) {
    hapticVolume = Math.max(0, Math.min(1, volume));
}

// Function to check if element is interactive
function isInteractiveElement(element) {
    const interactiveElements = [
        'a', 'button', 'input', 'select', 'textarea', 'label',
        '[role="button"]', '[role="link"]', '[role="checkbox"]', '[role="radio"]',
        '[role="switch"]', '[role="tab"]', '[role="menuitem"]'
    ];
    return interactiveElements.includes(element.tagName.toLowerCase()) || 
           interactiveElements.some(selector => element.matches(selector)) ||
           element.classList.contains('interactive') ||
           element.getAttribute('tabindex') === '0';
}

// Function to add haptic feedback
function addHapticFeedback(event) {
    if (isDebouncing) return;
    isDebouncing = true;

    let target = event.target;

    // Check if the clicked element or its parent is interactive
    while (target && target !== document.body) {
        if (isInteractiveElement(target)) {
            // Trigger vibration
            if ('vibrate' in navigator) {
                navigator.vibrate(50); // Short vibration, 50ms
            }

            // Play soft sound
            createSoftSound();
            break;
        }
        target = target.parentElement;
    }

    // Reset debounce after a short delay
    setTimeout(() => {
        isDebouncing = false;
    }, 100);
}

// Function to handle input events for sliders and other continuous inputs
function handleInputEvent(event) {
    if (isDebouncing) return;
    isDebouncing = true;

    if (event.target.type === 'range' || event.target.type === 'number') {
        if ('vibrate' in navigator) {
            navigator.vibrate(25); // Even shorter vibration for continuous input
        }
        createSoftSound();
    }

    // Reset debounce after a short delay
    setTimeout(() => {
        isDebouncing = false;
    }, 50); // Shorter delay for continuous inputs
}

// Add event listeners
document.addEventListener('click', addHapticFeedback, { capture: true });
document.addEventListener('touchstart', addHapticFeedback, { capture: true, passive: true });
document.addEventListener('input', handleInputEvent, { passive: true });

// Initialize audio context on first user interaction
document.addEventListener('click', initAudioContext, { once: true });

// Expose setHapticVolume function globally
window.setHapticVolume = setHapticVolume;


//stop copy paste

// Function to prevent copy-paste
function preventCopyPaste(e) {
    e.preventDefault();
    return false;
}

// Function to disable context menu
function disableContextMenu(e) {
    e.preventDefault();
    return false;
}

// Prevent copy-paste
document.addEventListener('copy', preventCopyPaste);
document.addEventListener('cut', preventCopyPaste);
document.addEventListener('paste', preventCopyPaste);

// Disable context menu
document.addEventListener('contextmenu', disableContextMenu);

// Apply user-select: none to the entire body
document.body.style.userSelect = 'none';
document.body.style.webkitUserSelect = 'none';
document.body.style.msUserSelect = 'none';
document.body.style.mozUserSelect = 'none';


            //backup model
            const backupModal = document.getElementById('backupModal');

            backupModal.addEventListener('click', function (event) {
                if (event.target.classList.contains('download-btn')) {
                    downloadBackup(event.target.dataset.type);
                } else if (event.target.classList.contains('send-btn')) {
                    sendBackup(event.target.dataset.type);
                }
            });

            function downloadBackup(dataType) {
                firebase.database().ref('parties').once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        const jsonData = JSON.stringify(data);
                        const blob = new Blob([jsonData], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);

                        const a = document.createElement('a');
                        const date = new Date().toISOString().replace(/[:.]/g, '-');
                        a.href = url;
                        a.download = `${dataType}_${date}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);

                        console.log('Backup downloaded successfully');
                    })
                    .catch((error) => {
                        console.error('Error creating backup:', error);
                    });
            }

            function sendBackup(dataType) {
                firebase.database().ref('parties').once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        const jsonData = JSON.stringify(data);

                        const chatId = '-4527298165';
                        const botToken = '7401966895:AAFu7gNrOPhMXJQNJTRk4CkK4TjRr09pxUs';
                        const date = new Date().toISOString().replace(/[:.]/g, '-');
                        const fileName = `${dataType}_${date}.json`;

                        const formData = new FormData();
                        formData.append('document', new Blob([jsonData], { type: 'application/json' }), fileName);

                        fetch(`https://api.telegram.org/bot${botToken}/sendDocument?chat_id=${chatId}`, {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => response.json())
                            .then(result => {
                                console.log('Backup sent successfully:', result);
                            })
                            .catch(error => {
                                console.error('Error sending backup:', error);
                            });
                    })
                    .catch((error) => {
                        console.error('Error creating backup:', error);
                    });
            }

            function sendItemsToTelegram() {
                firebase.database().ref('items').once('value')
                    .then((snapshot) => {
                        const items = snapshot.val();
                        const jsonData = JSON.stringify(items);

                        // Create a blob from the JSON data
                        const blob = new Blob([jsonData], { type: 'application/json' });

                        // Get the current date and time
                        const date = new Date();
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hour = String(date.getHours()).padStart(2, '0');
                        const minute = String(date.getMinutes()).padStart(2, '0');
                        const second = String(date.getSeconds()).padStart(2, '0');

                        // Create a file name
                        const fileName = `itemdata_${year}${month}${day}.json`;

                        // Create a file from the blob
                        const file = new File([blob], fileName, { type: 'application/json' });

                        // Create a form data object
                        const formData = new FormData();
                        formData.append('document', file);

                        // Send the file to Telegram
                        const url = `https://api.telegram.org/bot7401966895:AAFu7gNrOPhMXJQNJTRk4CkK4TjRr09pxUs/sendDocument?chat_id=-4527298165`;
                        fetch(url, {
                            method: 'POST',
                            body: formData,
                        })
                            .then(response => response.json())
                            .then(data => {
                                console.log('Item data sent to Telegram:', data);

                                // Create a backup details object
                                const backupDetails = {
                                    type: 'Item Data',
                                    date: `${year}-${month}-${day}`,
                                    time: `${hour}:${minute}:${second}`,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP
                                };

                                // Add the backup details to Firebase
                                firebase.database().ref('backupDetails').push(backupDetails);

                                // Refresh the backup details table
                                loadBackupDetails();

                                // Log the activity
                                logActivity('Sent item backup to Telegram', username);

                                alert('Item data has been sent to Telegram successfully!');
                            })
                            .catch(error => {
                                console.error('Error sending item data to Telegram:', error);
                                alert('Error sending item data to Telegram. Please try again.');
                            });
                    })
                    .catch((error) => {
                        console.error('Error creating item backup:', error);
                        alert('Error creating item backup. Please try again.');
                    });
            }

            // Function to download Item data
            function downloadItemBackup() {
                firebase.database().ref('items').once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        const jsonData = JSON.stringify(data);
                        const blob = new Blob([jsonData], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);

                        const a = document.createElement('a');
                        const date = new Date().toISOString().replace(/[:.]/g, '-');
                        a.href = url;
                        a.download = `itemdata_${date}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);

                        console.log('Item backup downloaded successfully');
                        logActivity('Downloaded item backup', username);
                        alert('Item backup has been downloaded successfully!');
                    })
                    .catch((error) => {
                        console.error('Error creating item backup:', error);
                        alert('Error creating item backup. Please try again.');
                    });
            }

            backupModal.addEventListener('click', function (event) {
                if (event.target.classList.contains('download-btn')) {
                    if (event.target.dataset.type === 'party') {
                        downloadBackup('party');
                    } else if (event.target.dataset.type === 'item') {
                        downloadItemBackup();
                    }
                } else if (event.target.classList.contains('send-btn')) {
                    if (event.target.dataset.type === 'party') {
                        sendPartyNamesToTelegram();
                    } else if (event.target.dataset.type === 'item') {
                        sendItemsToTelegram();
                    }
                }
            });

            //restore for party name
            const restoreModal = document.getElementById('restoreModal');
            const dataSelectionModal = new bootstrap.Modal(document.getElementById('dataSelectionModal'));
            const uploadButton = document.getElementById('uploadRestoreFile');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const restoreSelectedButton = document.getElementById('restoreSelectedData');
            let uploadedData = [];

            uploadButton.addEventListener('click', handleFileUpload);
            selectAllCheckbox.addEventListener('change', handleSelectAll);
            restoreSelectedButton.addEventListener('click', restoreSelectedData);

            function handleFileUpload() {
                const fileInput = document.getElementById('restoreFile');
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            processUploadedData(jsonData);
                        } catch (error) {
                            console.error('Error parsing JSON:', error);
                            alert('Invalid JSON file. Please try again.');
                        }
                    };
                    reader.readAsText(file);
                } else {
                    alert('Please select a file to upload.');
                }
            }

            function processUploadedData(data) {
                // Check if the data is an array (party names) or an object (item data)
                if (Array.isArray(data)) {
                    // Handle party data
                    firebase.database().ref('parties').once('value', (snapshot) => {
                        const existingData = snapshot.val() || [];
                        uploadedData = data.filter(item => !existingData.includes(item));

                        if (uploadedData.length > 0) {
                            populateDataSelectionModal(uploadedData, 'party');
                            bootstrap.Modal.getInstance(restoreModal).hide();
                            dataSelectionModal.show();
                        } else {
                            alert('No new party data to restore.');
                        }
                    });
                } else if (typeof data === 'object') {
                    // Handle item data
                    firebase.database().ref('items').once('value', (snapshot) => {
                        const existingData = snapshot.val() || {};
                        uploadedData = Object.entries(data).filter(([key, item]) => {
                            return !existingData[key] || JSON.stringify(existingData[key]) !== JSON.stringify(item);
                        });

                        if (uploadedData.length > 0) {
                            populateDataSelectionModal(uploadedData, 'item');
                            bootstrap.Modal.getInstance(restoreModal).hide();
                            dataSelectionModal.show();
                        } else {
                            alert('No new item data to restore.');
                        }
                    });
                } else {
                    alert('Invalid data format in the uploaded file.');
                }
            }
            function populateDataSelectionModal(data, dataType) {
                const tbody = document.getElementById('dataSelectionBody');
                tbody.innerHTML = '';
                data.forEach((item, index) => {
                    const row = document.createElement('tr');
                    if (dataType === 'party') {
                        row.innerHTML = `
                <td><input type="checkbox" class="row-checkbox" data-index="${index}"></td>
                <td>${item}</td>
            `;
                    } else if (dataType === 'item') {
                        const [key, itemData] = item;
                        row.innerHTML = `
                <td><input type="checkbox" class="row-checkbox" data-index="${index}"></td>
                <td>${itemData.name}</td>
                <td>${itemData.category ? itemData.category.join(', ') : 'N/A'}</td>
                <td>${itemData.sizes ? itemData.sizes.join(', ') : 'N/A'}</td>
            `;
                    }
                    tbody.appendChild(row);
                });

                // Update modal title
                document.querySelector('#dataSelectionModal .modal-title').textContent =
                    `Select ${dataType === 'party' ? 'Parties' : 'Items'} to Restore`;

                // Store the data type for use in restoreSelectedData
                document.getElementById('dataSelectionModal').setAttribute('data-type', dataType);
            }

            function handleSelectAll() {
                const isChecked = selectAllCheckbox.checked;
                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            }

            function restoreSelectedData() {
                const selectedIndices = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                    .map(checkbox => parseInt(checkbox.getAttribute('data-index')));

                const dataType = document.getElementById('dataSelectionModal').getAttribute('data-type');
                const dataToRestore = selectedIndices.map(index => uploadedData[index]);

                if (dataToRestore.length > 0) {
                    if (dataType === 'party') {
                        firebase.database().ref('parties').once('value', (snapshot) => {
                            const existingData = snapshot.val() || [];
                            const updatedData = [...new Set([...existingData, ...dataToRestore])];

                            firebase.database().ref('parties').set(updatedData)
                                .then(() => {
                                    alert('Selected parties restored successfully!');
                                    dataSelectionModal.hide();
                                    loadPartyMaster(); // Refresh the party master view
                                    logActivity('Restored parties', username);
                                })
                                .catch(error => {
                                    console.error('Error restoring parties:', error);
                                    alert('Error restoring parties. Please try again.');
                                });
                        });
                    } else if (dataType === 'item') {
                        firebase.database().ref('items').once('value', (snapshot) => {
                            const existingData = snapshot.val() || {};
                            const updatedData = { ...existingData };

                            dataToRestore.forEach(([key, item]) => {
                                updatedData[key] = item;
                            });

                            firebase.database().ref('items').set(updatedData)
                                .then(() => {
                                    alert('Selected items restored successfully!');
                                    dataSelectionModal.hide();
                                    loadItemMaster(); // Refresh the item master view
                                    logActivity('Restored items', username);
                                })
                                .catch(error => {
                                    console.error('Error restoring items:', error);
                                    alert('Error restoring items. Please try again.');
                                });
                        });
                    }
                } else {
                    alert('No data selected for restoration.');
                }
            }

            //master
            document.getElementById('itemMasterBtn').addEventListener('click', function () {
                showSection('itemMaster');
                loadItemMaster();
            });

          

            function loadItemMaster() {
                const itemMasterBody = document.getElementById('itemMasterBody');
                itemMasterBody.innerHTML = '';

                // Predefined items
                const predefinedItems = [
                    { name: "o.e 2pccs", category: ["mix", "1pcs", "2pcs"], sizes: ["s", "m", "l", "xl", "2xl"] },
                    { name: "reply", sizes: ["s", "m", "l", "xl", "2xl"] },
                    { name: "clasz", sizes: ["45", "50", "55", "60", "65", "70", "75"] },
                    { name: "salsa", sizes: ["45", "50", "55", "60", "65", "70", "75"] }
                ];

                // Load predefined items
                predefinedItems.forEach((item, index) => {
                    addItemToTable(item, index, true);
                });

                // Load custom items from Firebase
                firebase.database().ref('items').once('value', (snapshot) => {
                    const firebaseItems = snapshot.val();
                    if (firebaseItems) {
                        Object.entries(firebaseItems).forEach(([key, item]) => {
                            if (!predefinedItems.some(predefined => predefined.name === item.name)) {
                                addItemToTable(item, key, false);
                            }
                        });
                    }
                });

                function addItemToTable(item, key, isPredefined) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.category ? item.category.join(', ') : 'N/A'}</td>
            <td>${item.sizes ? item.sizes.join(', ') : 'N/A'}</td>
            <td>
                ${isPredefined ? '' : `
                    <button class="btn btn-sm btn-primary edit-item" data-key="${key}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-item" data-key="${key}">Delete</button>
                `}
            </td>
        `;
                    itemMasterBody.appendChild(row);

                    if (!isPredefined) {
                        row.querySelector('.edit-item').addEventListener('click', () => editItem(key));
                        row.querySelector('.delete-item').addEventListener('click', () => deleteItem(key));
                    }
                }
            }

            // Function to edit an item
            function editItem(key) {
                firebase.database().ref('items').child(key).once('value', (snapshot) => {
                    const item = snapshot.val();
                    if (item) {
                        const newName = prompt('Enter new item name:', item.name);
                        if (newName && newName !== item.name) {
                            item.name = newName;
                            firebase.database().ref('items').child(key).set(item).then(() => {
                                loadItemMaster();
                                logActivity('Edited item name', username, `${item.name} to ${newName}`);
                            }).catch(error => {
                                console.error("Error updating item:", error);
                                alert("Error updating item. Please try again.");
                            });
                        }
                    } else {
                        console.error("Item not found");
                        alert("Item not found. Please refresh and try again.");
                    }
                });
            }

            // Function to delete an item
            function deleteItem(key) {
                if (confirm('Are you sure you want to delete this item?')) {
                    firebase.database().ref('items').child(key).once('value', (snapshot) => {
                        const item = snapshot.val();
                        if (item) {
                            firebase.database().ref('items').child(key).remove().then(() => {
                                loadItemMaster();
                                logActivity('Deleted item', username, item.name);
                            }).catch(error => {
                                console.error("Error deleting item:", error);
                                alert("Error deleting item. Please try again.");
                            });
                        } else {
                            console.error("Item not found");
                            alert("Item not found. Please refresh and try again.");
                        }
                    });
                }
            }

            loadItemsFromFirebase();

            const itemSearch = document.getElementById('itemSearch');
            const itemList = document.getElementById('itemList');

            itemSearch.addEventListener('focus', () => showItems());
            itemSearch.addEventListener('input', () => showItems(itemSearch.value));

            document.addEventListener('click', function (e) {
                if (e.target !== itemSearch && !itemList.contains(e.target)) {
                    itemList.style.display = 'none';
                }
            });

            function showItems(filter = '') {
    const itemList = document.getElementById('itemList');
    itemList.innerHTML = '';
    const filteredItems = items.filter(item =>
        item && item.name && item.name.toLowerCase().includes(filter.toLowerCase())
    );

    filteredItems.forEach(item => {
        const element = document.createElement('a');
        element.classList.add('list-group-item', 'list-group-item-action');
        element.textContent = item.name;
        element.href = '#';
        element.addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('itemSearch').value = item.name;
            showItemDetails(item);
            itemList.style.display = 'none';
        });
        itemList.appendChild(element);
    });

    if (filteredItems.length === 0 && filter !== '') {
        const addNewItemElement = document.createElement('a');
        addNewItemElement.classList.add('list-group-item', 'list-group-item-action');
        addNewItemElement.textContent = `Add "${filter}" as a new item`;
        addNewItemElement.href = '#';
        addNewItemElement.addEventListener('click', function (e) {
            e.preventDefault();
            addNewItem(filter);
            itemList.style.display = 'none';
        });
        itemList.appendChild(addNewItemElement);
    }

    itemList.style.display = 'block';
}

            //user management
            document.getElementById('usersBtn').addEventListener('click', function () {
                showSection('users');
                loadUsers();
            });

            document.getElementById('approvalRequestsBtn').addEventListener('click', function () {
                showSection('approvalRequests');
                loadApprovalRequests();
            });

            function loadUsers() {
                const usersBody = document.getElementById('usersBody');
                usersBody.innerHTML = '';

                firebase.database().ref('users').once('value', (snapshot) => {
                    const users = snapshot.val();
                    if (users) {
                        Object.entries(users).forEach(([key, value]) => {
                            const row = document.createElement('tr');
                            const isCurrentUser = value === username;
                            row.innerHTML = `
                    <td>${value}${isCurrentUser ? ' (me)' : ''}</td>
                    <td>
                        ${isCurrentUser ? '' : `<button class="btn btn-sm btn-danger delete-user" data-key="${key}">Delete</button>`}
                    </td>
                `;
                            usersBody.appendChild(row);
                        });

                        // Add event listeners for delete buttons
                        document.querySelectorAll('.delete-user').forEach(button => {
                            button.addEventListener('click', function () {
                                const key = this.getAttribute('data-key');
                                deleteUser(key);
                            });
                        });
                    }
                });
            }

            function deleteUser(key) {
                // Create the modal HTML
                const modalHtml = `
    <div class="modal fade" id="passwordModal" tabindex="-1" role="dialog" aria-labelledby="passwordModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="passwordModalLabel">Authentication Required</h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p class="mb-3">Please enter your password to proceed with the delete action.</p>
            <div class="form-group">
              <label for="passwordInput" class="sr-only">Password</label>
              <input type="password" id="passwordInput" class="form-control" placeholder="Enter password">
              <div id="passwordError" class="invalid-feedback">
                Incorrect password. Please try again.
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="submitPassword">Submit</button>
          </div>
        </div>
      </div>
    </div>
  `;

                // Append the modal to the body if it doesn't exist
                if (!document.getElementById('passwordModal')) {
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                }

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
                modal.show();

                // Handle close button
                document.querySelector('#passwordModal .close').addEventListener('click', () => {
                    modal.hide();
                });

                // Handle cancel button
                document.querySelector('#passwordModal .btn-secondary').addEventListener('click', () => {
                    modal.hide();
                });

                // Handle password submission
                document.getElementById('submitPassword').onclick = function () {
                    const passwordInput = document.getElementById('passwordInput');
                    const password = passwordInput.value;
                    if (password === '9284494154') {
                        modal.hide();
                        passwordInput.value = ''; // Clear the password

                        firebase.database().ref('users').child(key).once('value', (snapshot) => {
                            const deletedUsername = snapshot.val();
                            firebase.database().ref('users').child(key).remove().then(() => {
                                loadUsers();
                                logActivity('Deleted user', deletedUsername);

                                // If the deleted user is the current user, clear localStorage and reload
                                if (deletedUsername === username) {
                                    localStorage.removeItem('hcUsername');
                                    location.reload();
                                }
                            }).catch(error => {
                                console.error("Error deleting user:", error);
                            });
                        });
                    } else {
                        passwordInput.classList.add('is-invalid');
                        document.getElementById('passwordError').style.display = 'block';
                    }
                };

                // Reset error state when input changes
                document.getElementById('passwordInput').addEventListener('input', function () {
                    this.classList.remove('is-invalid');
                    document.getElementById('passwordError').style.display = 'none';
                });

                // Clear password when modal is hidden
                document.getElementById('passwordModal').addEventListener('hidden.bs.modal', function () {
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').classList.remove('is-invalid');
                    document.getElementById('passwordError').style.display = 'none';
                });
            }

            function loadApprovalRequests() {
                const approvalRequestsBody = document.getElementById('approvalRequestsBody');
                approvalRequestsBody.innerHTML = '';

                firebase.database().ref('approvalRequests').once('value', (snapshot) => {
                    const requests = snapshot.val();
                    if (requests) {
                        Object.entries(requests).forEach(([key, value]) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                        <td>${value}</td>
                        <td>
                            <button class="btn btn-sm btn-success approve-user" data-key="${key}">Approve</button>
                            <button class="btn btn-sm btn-danger reject-user" data-key="${key}">Reject</button>
                        </td>
                    `;
                            approvalRequestsBody.appendChild(row);
                        });

                        // Add event listeners for approve and reject buttons
                        document.querySelectorAll('.approve-user, .reject-user').forEach(button => {
                            button.addEventListener('click', function () {
                                const key = this.getAttribute('data-key');
                                const action = this.classList.contains('approve-user') ? 'approve' : 'reject';
                                handleApprovalRequest(key, action);
                            });
                        });
                    }
                });
            }

            function handleApprovalRequest(key, action) {
                // Create the modal HTML
                const modalHtml = `
        <div class="modal fade" id="passwordModal2" tabindex="-1" role="dialog" aria-labelledby="passwordModalLabel2" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="passwordModalLabel2">Authentication Required</h5>
                        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">Please enter your password to proceed with the ${action} action.</p>
                        <div class="form-group">
                            <label for="passwordInput2" class="sr-only">Password</label>
                            <input type="password" id="passwordInput2" class="form-control" placeholder="Enter password">
                            <div id="passwordError2" class="invalid-feedback">
                                Incorrect password. Please try again.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="submitPassword2">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    `;

                // Append the modal to the body if it doesn't exist
                if (!document.getElementById('passwordModal2')) {
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                }

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('passwordModal2'));
                modal.show();
                // Handle close button
                document.querySelector('#passwordModal2 .close').addEventListener('click', () => {
                    modal.hide();
                });

                // Handle cancel button
                document.querySelector('#passwordModal2 .btn-secondary').addEventListener('click', () => {
                    modal.hide();
                });
                // Handle password submission
                document.getElementById('submitPassword2').onclick = function () {
                    const passwordInput = document.getElementById('passwordInput2');
                    const password = passwordInput.value;
                    if (password === '9284494154') {
                        modal.hide();
                        passwordInput.value = ''; // Clear the password

                        if (action === 'approve') {
                            firebase.database().ref('approvalRequests').child(key).once('value', (snapshot) => {
                                const username = snapshot.val();
                                firebase.database().ref('users').push(username).then(() => {
                                    firebase.database().ref('approvalRequests').child(key).remove();
                                    loadApprovalRequests();
                                    logActivity('Approved user', username);
                                });
                            });
                        } else {
                            firebase.database().ref('approvalRequests').child(key).remove().then(() => {
                                loadApprovalRequests();
                                logActivity('Rejected user', key);
                            });
                        }
                    } else {
                        passwordInput.classList.add('is-invalid');
                        document.getElementById('passwordError2').style.display = 'block';
                    }
                };

                // Reset error state when input changes
                document.getElementById('passwordInput2').addEventListener('input', function () {
                    this.classList.remove('is-invalid');
                    document.getElementById('passwordError2').style.display = 'none';
                });

                // Clear password when modal is hidden
                document.getElementById('passwordModal2').addEventListener('hidden.bs.modal', function () {
                    document.getElementById('passwordInput2').value = '';
                    document.getElementById('passwordInput2').classList.remove('is-invalid');
                    document.getElementById('passwordError2').style.display = 'none';
                });
            }
        });

        //slidng
        document.addEventListener('DOMContentLoaded', function () {
            const slideMenu = document.getElementById('slideMenu');
            const menuToggle = document.getElementById('menuToggle');
            const closeBtn = document.querySelector('.close-btn');

            function showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
            }

            menuToggle.addEventListener('click', function () {
                slideMenu.style.width = '250px';
            });

            closeBtn.addEventListener('click', function () {
                slideMenu.style.width = '0';
            });

            slideMenu.querySelectorAll('a[data-section]').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                    slideMenu.style.width = '0';
                });
            });

            menuToggle.addEventListener('click', function () {
                slideMenu.style.width = '250px';
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            });

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });

            window.addEventListener('click', function (event) {
                if (!slideMenu.contains(event.target) && event.target !== menuToggle) {
                    slideMenu.style.width = '0';
                }
            });
            // Add event listeners for Master and Party Master buttons
            document.getElementById('partyMasterBtn').addEventListener('click', function () {
                showSection('partyMaster');
                loadPartyMaster();
            });


            function loadPartyMaster() {
    const partyMasterBody = document.getElementById('partyMasterBody');
    partyMasterBody.innerHTML = '';

    // Define predefined parties
    const predefinedParties = [
        "PARTY A - AREA1", "PARTY B - AREA2", "PARTY C - AREA3", "XYLO - AREA4"
    ];

    firebase.database().ref('parties').once('value', (snapshot) => {
        const firebaseParties = snapshot.val();
        if (firebaseParties) {
            firebaseParties.forEach((party, index) => {
                const row = document.createElement('tr');
                if (predefinedParties.includes(party)) {
                    // For predefined parties, don't include edit and delete buttons
                    row.innerHTML = `
                        <td>${party}</td>
                        <td></td>
                    `;
                } else {
                    // For custom parties, include edit and delete buttons
                    row.innerHTML = `
                        <td>${party}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-party" data-index="${index}">Edit</button>
                            <button class="btn btn-sm btn-danger delete-party" data-index="${index}">Delete</button>
                        </td>
                    `;
                }
                partyMasterBody.appendChild(row);
            });

            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-party').forEach(button => {
                button.addEventListener('click', function () {
                    const index = this.getAttribute('data-index');
                    editParty(index);
                });
            });

            document.querySelectorAll('.delete-party').forEach(button => {
                button.addEventListener('click', function () {
                    const index = this.getAttribute('data-index');
                    deleteParty(index);
                });
            });
        }
    });
}


function editParty(index) {
    firebase.database().ref('parties').once('value', (snapshot) => {
        const parties = snapshot.val();
        const oldName = parties[index];
        let newName = prompt('Enter new party name (format: PARTY NAME - AREA):', oldName);
        
        if (newName && newName !== oldName) {
            // Validate the format
            const formatRegex = /^.+\s-\s.+$/;
            if (!formatRegex.test(newName)) {
                alert('Invalid format. Please use the format: PARTY NAME - AREA');
                return;
            }

            // Split the name into party name and area
            const parts = newName.split('-').map(part => part.trim());
            if (parts.length !== 2) {
                alert('The name must contain exactly one hyphen (-)');
                return;
            }

            // Capitalize the party name and area
            const [partyName, area] = parts.map(part => part.toUpperCase());
            newName = `${partyName} - ${area}`;

            parties[index] = newName;
            firebase.database().ref('parties').set(parties).then(() => {
                loadPartyMaster();
                logActivity('Edited party name', oldName, newName);
            }).catch(error => {
                console.error("Error updating party:", error);
            });
        }
    });
}

            function deleteParty(index) {
                if (confirm('Are you sure you want to delete this party?')) {
                    firebase.database().ref('parties').once('value', (snapshot) => {
                        const parties = snapshot.val();
                        const deletedParty = parties[index];
                        parties.splice(index, 1);
                        firebase.database().ref('parties').set(parties).then(() => {
                            loadPartyMaster();
                            logActivity('Deleted party', deletedParty);
                        }).catch(error => {
                            console.error("Error deleting party:", error);
                        });
                    });
                }
            }

            function logActivity(action, username) {
                const now = new Date();
                const activityLog = {
                    action: action,
                    username: username,
                    timestamp: now.toISOString(),
                    date: now.toLocaleDateString(),
                    time: now.toLocaleTimeString()
                };
                firebase.database().ref('activityLogs').push(activityLog);
            }

        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(navLink => navLink.classList.remove('active'));
                const sectionId = this.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
                this.classList.add('active');
            });
        });


        //ACTIVITY LOG
        document.querySelector('a[data-section="activityLogs"]').addEventListener('click', loadActivityLogs);
        function loadActivityLogs() {
            const activityLogsSection = document.getElementById('activityLogs');
            const logList = document.createElement('ul');
            logList.className = 'list-group';

            firebase.database().ref('activityLogs').orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                logList.innerHTML = ''; // Clear existing logs
                const logs = [];
                snapshot.forEach((childSnapshot) => {
                    logs.push(childSnapshot.val());
                });
                logs.reverse().forEach((log) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';

                    // Format date and time consistently
                    const dateTime = new Date(log.timestamp);
                    const formattedDateTime = dateTime.toLocaleString('en-US', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });

                    let logMessage = `${formattedDateTime}: ${log.username}: ${log.action}`;
                    if (log.action === 'Created new party' && log.partyName) {
                        logMessage += ` "${log.partyName}"`;
                    }

                    listItem.textContent = logMessage;
                    logList.appendChild(listItem);
                });
            });


            activityLogsSection.innerHTML = ''; // Clear previous content
            activityLogsSection.appendChild(logList);
        }
        //hc text animation
        const hcText = document.querySelector('.hc-text');
        let gradientAngle = 0;

        function updateGradient() {
            gradientAngle += 1; // Adjust the speed by changing the increment
            hcText.style.backgroundImage = `linear-gradient(${gradientAngle}deg, #8B0000, #0000FF)`;
        }

        setInterval(updateGradient, 50); // Update every 50 milliseconds (adjust as needed)
        function adjustForMobileView() {
            if (window.innerWidth <= 768) {
                document.querySelectorAll('.table').forEach(table => {
                    table.classList.add('table-responsive');
                });
            } else {
                document.querySelectorAll('.table').forEach(table => {
                    table.classList.remove('table-responsive');
                });
            }
        }


        window.addEventListener('resize', adjustForMobileView);
        adjustForMobileView();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>

</body>

</html>
